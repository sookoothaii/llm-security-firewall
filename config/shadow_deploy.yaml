# Shadow Deployment Configuration
# WARN-Only Mode for Production Telemetry Collection
#
# Purpose: Collect real-world FPR/ASR data without blocking user requests
# Duration: Initial phase (1-2 weeks)
# Review: Daily FPR monitoring, weekly ASR analysis

runtime:
  mode: shadow_warn           # Returns PASS to caller, logs detections

  log:
    # Evidence ledger for forensic analysis
    evidence_ledger: on

    # Fields to log per detection (stratified analysis)
    fields:
      - ctx                   # Context (documentation/generic)
      - doc_like              # Short doc-like snippet
      - exec_ctx              # Execution context present
      - has_codefence         # Contains code fence (```)
      - has_net_api           # Contains network API calls
      - has_js_attr           # Contains JavaScript attributes
      - risk                  # Risk score
      - action                # PASS/WARN/BLOCK
      - top_signals           # Top 5 detector hits (for analysis)
      - families              # Active feature families
      - contrib               # Signal contributions

    # Log destination
    destination: prometheus   # For grafana dashboards
    fallback: json_file       # Backup to local files

  sampling:
    # Sample rate for telemetry (1.0 = 100%)
    rate: 1.0                 # Full sampling during initial phase

    # Reduce after stabilization
    schedule:
      - days: 1-7
        rate: 1.0
      - days: 8-14
        rate: 0.5
      - days: 15+
        rate: 0.1

  redact:
    # Maximum chars to log (privacy)
    max_chars: 4096
    # PII patterns to redact
    patterns:
      - email
      - credit_card
      - ssn

gates:
  # CI/CD enforcement gates
  ci:
    # ASR gate (enforced)
    asr_overall_wilson_upper_max: 5.00

    # FPR gate (stratified - PRIMARY)
    fpr:
      mode: advisory          # Don't block deploys during shadow

      # Stratified targets (measured separately)
      stratify:
        - pure_doc            # Primary gate: Upper <=1.50%
        - doc_with_codefence  # Secondary: Upper <=1.50%
        - doc_with_exec       # Excluded (educational content)
        - code_cfg            # Advisory: Upper <=1.00%

      targets:
        pure_doc_upper_max: 1.50
        doc_with_codefence_upper_max: 1.50
        code_cfg_upper_max: 1.00

      min_samples:
        pure_doc: 1000        # Need statistical confidence
        doc_with_codefence: 1000
        code_cfg: 500

      # Exclude from FPR gate (not "benign")
      exclude:
        - doc_with_exec       # Educational attack examples (TRUE positives)

  # Runtime thresholds (same as production-candidate)
  thresholds:
    warn: 0.7                 # Natural language context
    block: 2.0                # Hard block threshold

    context_specific:
      code_warn: 1.4
      config_warn: 1.2

monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
    metrics:
      - fpr_rate
      - asr_rate
      - latency_p50_p90_p99
      - signal_frequencies
      - context_distribution

  # Alerts (stratified)
  alerts:
    # FPR spike detection (stratified)
    - name: fpr_pure_doc_spike
      condition: fpr_pure_doc_upper > 0.02  # 2.0%
      window: 24h
      action: freeze_rollout

    - name: fpr_codefence_spike
      condition: fpr_doc_with_codefence_upper > 0.02  # 2.0%
      window: 24h
      action: notify

    # Appeal rate (proxy for real FPs)
    - name: appeal_rate_high
      condition: appeals_rate > 0.005  # 0.5%
      window: 24h
      action: freeze_rollout

    # Latency degradation
    - name: latency_p99_high
      condition: latency_p99 > 100  # ms
      window: 5m
      action: notify

    # Unknown signals
    - name: unknown_signal_detected
      condition: signal not in KNOWN_SIGNALS
      action: log

telemetry:
  # Real-world data collection targets
  targets:
    # Minimum samples per category
    conversations: 5000
    documentation: 2000
    code_snippets: 1000

    # Diversity metrics
    unique_users: 100
    time_periods: 24h_coverage

  # Review schedule
  review:
    daily:
      - fpr_trend
      - new_signal_discovery
      - latency_distribution

    weekly:
      - asr_validation
      - per_category_analysis
      - threshold_calibration

  # Escalation criteria
  escalate_if:
    fpr_above: 0.10           # 10%
    latency_p99_above: 200    # ms
    unknown_signals: 5        # per day

deployment:
  # Progressive rollout (stratified gates)
  rollout:
    - phase: canary
      traffic: 0.01           # 1%
      duration: 24h
      gates:
        - asr_overall_upper <= 5.00
        - fpr_pure_doc_upper <= 2.00  # Relaxed for canary
        - fpr_doc_with_codefence_upper <= 1.50
        - latency_p99 < 60
        - no_crashes

    - phase: shadow
      traffic: 0.10           # 10%
      duration: 72h
      gates:
        - asr_overall_upper <= 5.00
        - fpr_pure_doc_upper <= 1.50  # Target gate
        - fpr_doc_with_codefence_upper <= 1.50
        - sustained_days: 3   # 3 consecutive days stable
        - no_crashes

    - phase: expansion
      traffic: 0.50           # 50%
      duration: 1week
      gates:
        - asr_overall_upper <= 5.00
        - fpr_pure_doc_upper <= 1.50
        - sustained_days: 3
        - appeals_rate <= 0.005  # 0.5%

    - phase: full
      traffic: 1.0            # 100%
      requires:
        - manual_approval
        - fpr_gate_pass
        - asr_gate_pass

# Emergency procedures
emergency:
  # Kill switch criteria
  kill_switch_if:
    - fpr > 0.20              # 20%
    - asr_spike > 0.10        # 10%
    - latency_p99 > 500       # ms
    - crashes > 10            # per hour

  # Rollback
  rollback_to: previous_version
  notify: ops_team
