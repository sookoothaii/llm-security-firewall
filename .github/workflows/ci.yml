name: CI Tests

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: test (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.python-version == '3.15' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.12", "3.13", "3.14", "3.15"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        allow-prereleases: true
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        pytest tests/ -v --cov=src/llm_firewall --cov-report=xml --cov-report=term --junitxml=pytest-report.xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
        fail_ci_if_error: false
    
    - name: Upload test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: junit-${{ matrix.os }}-py${{ matrix.python-version }}
        path: pytest-report.xml

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install linting tools
      run: |
        pip install ruff mypy types-PyYAML types-requests
    
    - name: Run Ruff
      run: ruff check .
    
    - name: Run MyPy
      run: mypy src/ --ignore-missing-imports

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install security scanners
      run: pip install bandit pip-audit
    
    - name: Run Bandit
      run: bandit -r src/ -ll
    
    - name: Check dependencies (pip-audit)
      run: pip-audit --require-hashes --disable-pip || true
    
    - name: Secrets scan (Gitleaks)
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docs:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install markdownlint
      run: npm install -g markdownlint-cli2
    
    - name: Create markdownlint config
      run: |
        cat > .markdownlint-cli2.yaml << 'EOF'
        config:
          default: true
          MD013: false
          MD022: false
          MD024: false
          MD026: false
          MD031: false
          MD032: false
          MD033: false
          MD036: false
          MD041: false
          MD050: false
          MD034: true
          MD040: true
          MD012:
            maximum: 2
        globs:
          - "**/*.md"
        ignores:
          - "node_modules"
        EOF
    
    - name: Lint Markdown files
      run: markdownlint-cli2 "**/*.md"
      continue-on-error: false
    
    - name: Check links (lychee)
      uses: lycheeverse/lychee-action@v1
      with:
        args: --no-progress --timeout 20 --retry-wait-time 2 --max-retries 3 "**/*.md"
        fail: true
